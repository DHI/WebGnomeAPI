stages:
  - test
  - build
  - deploy

services:
  - redis:latest

main:
  stage: build
  script:
    - git clone --depth 1 -b main https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.orr.noaa.gov/gnome/libgoods.git
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull registry.orr.noaa.gov/gnome/pygnome:main
    - docker tag registry.orr.noaa.gov/gnome/pygnome:main pygnome
    - docker build -f dockerfile . -t registry.orr.noaa.gov/gnome/webgnomeapi:main
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push registry.orr.noaa.gov/gnome/webgnomeapi:main
  only:
    - main
    - production
  image: registry.orr.noaa.gov/gnome/pygnome:main
  tags:
    - shell
    - build

develop:
  stage: build
  script:
    - yum install redis -y
    - redis-server --daemonize yes
    - echo conda env name $CONDA_DEFAULT_ENV
    - echo conda env path $CONDA_PREFIX
    - git clone --depth 1 -b develop https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.orr.noaa.gov/gnome/libgoods.git
    - conda install mamba
    - mamba install -y --file conda_requirements.txt
                       --file conda_requirements_test.txt
                       --file libgoods/libgoods/conda_requirements.txt
                       --file libgoods/model_catalogs/conda_requirements.txt

    - pip install -r libgoods/model_catalogs/pip_requirements.txt

    - pip install -e libgoods/model_catalogs/
    - pip install libgoods/libgoods
    - pip install .
    - mkdir -p ${HOME}/catalogs/complete
    - cp libgoods/model_catalogs/model_catalogs/model_catalogs/catalogs/complete/* ${HOME}/catalogs/complete/
    - python setup.py compilejson
    - pytest webgnome_api/tests
    - ps
    - jobs
  tags:
    - docker

test_main:
  stage: test
  image: registry.orr.noaa.gov/gnome/pygnome:main
  script:
    - yum install redis -y
    - redis-server --daemonize yes
    - git clone --depth 1 -b main https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.orr.noaa.gov/gnome/libgoods.git
    - conda install mamba
    - mamba install -y --file conda_requirements.txt
                       --file conda_requirements_test.txt
                       --file libgoods/libgoods/conda_requirements.txt
                       --file libgoods/model_catalogs/conda_requirements.txt
    - pip install -r libgoods/model_catalogs/pip_requirements.txt
    - pip install -e libgoods/model_catalogs/
    - pip install libgoods/libgoods
    - pip install .
    - mkdir -p ${HOME}/catalogs/complete
    - cp -d libgoods/model_catalogs/model_catalogs/catalogs/complete/* ${HOME}/catalogs/complete/
    - python setup.py compilejson
    - pytest webgnome_api/tests
    - ps
    - jobs
  only:
    - main
  tags:
    - docker

test_production:
  stage: test
  image: registry.orr.noaa.gov/gnome/pygnome:production
  script:
    - yum install redis -y
    - redis-server --daemonize yes
    - git clone --depth 1 -b main https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.orr.noaa.gov/gnome/libgoods.git
    - conda install mamba
    - mamba install -y --file conda_requirements.txt
                       --file conda_requirements_test.txt
                       --file libgoods/conda_requirements.txt
                       --file libgoods/model_catalogs/conda_requirements.txt
    - pip install -r libgoods/model_catalogs/pip_requirements.txt

    - pip install -e libgoods/model_catalogs/
    - pip install libgoods/libgoods
    - pip install .
    - mkdir -p ${HOME}/catalogs/complete
    - cp -d libgoods/model_catalogs/model_catalogs/catalogs/complete/* ${HOME}/catalogs/complete/
    - python setup.py compilejson
    - pytest webgnome_api/tests
    - ps
    - jobs
  only:
    - production
  tags:
    - docker

production:
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull registry.orr.noaa.gov/gnome/pygnome:production
    - docker tag registry.orr.noaa.gov/gnome/pygnome:production pygnome
    - docker build -f dockerfile . -t registry.orr.noaa.gov/gnome/webgnomeapi:production
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push registry.orr.noaa.gov/gnome/webgnomeapi:production
  only:
    - production
  tags:
    - shell
    - build

deploy_api_dev:
  stage: deploy
  only:
    - develop
  except:
    - schedules
  environment:
    name: gnome-dev
    url: https://gnome-dev.orr.noaa.gov
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    CONTAINER_NAME: webgnome_web_api
    APP_NETWORK: webgnome_net
    PORT_MAPPING: 8084:9898
  script:
    - yum install redis -y
    - redis-server --daemonize yes
    - echo conda env name $CONDA_DEFAULT_ENV
    - echo conda env path $CONDA_PREFIX
    - git clone --depth 1 -b develop https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.orr.noaa.gov/gnome/libgoods.git
    - conda install mamba
    - mamba install -y --file conda_requirements.txt
                       --file conda_requirements_test.txt
                       --file libgoods/conda_requirements.txt
                       --file libgoods/model_catalogs/conda_requirements.txt
    - pip install -r libgoods/model_catalogs/pip_requirements.txt

    - pip install -e libgoods/model_catalogs/
    - pip install libgoods/libgoods
    - pip install .
    - mkdir -p ${HOME}/catalogs/complete
    - cp -d libgoods/model_catalogs/model_catalogs/catalogs/complete/* ${HOME}/catalogs/complete/
    - python setup.py compilejson
    - pytest webgnome_api/tests
    - ps
    - jobs
  tags:
    - gnome-dev
    - deploy
